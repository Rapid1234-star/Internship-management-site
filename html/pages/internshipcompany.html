<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Internships - Company Portal</title>
    <link rel="stylesheet" href="../css/styles.css" />
  </head>
  <body>
    <header>
      <div class="header-container">
        <nav class="nav">
          <div class="nav-container">
            <a href="/dashboardcompany.html" class="nav-brand"
              >Internship Portal</a
            >
            <ul class="nav-links">
              <li>
                <a href="/dashboardcompany.html" class="nav-link">Dashboard</a>
              </li>
              <li>
                <a href="/profilecompany.html" class="nav-link">Profile</a>
              </li>
              <li><a href="/logout" class="nav-link">Logout</a></li>
            </ul>
          </div>
        </nav>
      </div>
    </header>

    <main>
      <div class="section-heading">
        <h1>Manage Internships</h1>
        <p>View and manage all your internship postings</p>
      </div>

      <div class="search-container">
        <form id="internship-search-form" class="search-form">
          <div class="search-filters">
            <div class="form-group">
              <label for="location" class="form-label">Location</label>
              <input
                type="text"
                id="location"
                name="location"
                class="form-input"
                placeholder="Enter location"
              />
            </div>
            <div class="form-group">
              <label for="skills" class="form-label">Skills</label>
              <input
                type="text"
                id="skills"
                name="skills"
                class="form-input"
                placeholder="Enter skills"
              />
            </div>
            <div class="form-group">
              <label for="salary" class="form-label">Min Salary (AED)</label>
              <input
                type="number"
                id="salary"
                name="salary"
                class="form-input"
                placeholder="Enter minimum salary"
                step="0.01"
              />
            </div>
          </div>
          <div class="search-actions">
            <button type="submit" class="btn btn-primary">
              Search Internships
            </button>
            <button type="button" class="btn btn-ghost" onclick="clearSearch()">
              Clear Search
            </button>
          </div>
        </form>
      </div>

      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Title</th>
              <th>Location</th>
              <th>Type</th>
              <th>Skills</th>
              <th>Salary</th>
              <th>Duration</th>
              <th>Deadline</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="internship-table-body">
            <tr>
              <td colspan="8" class="text-center">
                <div class="loading">
                  <div class="loading"></div>
                  <p>Loading internships...</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>

    <script>
      function loadInternships() {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", "/list_internships_company", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4 && xhr.status === 200) {
            const internships = JSON.parse(xhr.responseText);
            const tableBody = document.getElementById("internship-table-body");
            tableBody.innerHTML = "";

            if (internships.length === 0) {
              tableBody.innerHTML = `
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="empty-state">
                                        <h3>No internships found</h3>
                                        <p>You haven't posted any internships yet. <a href="/newinternshipcompany.html" class="text-link">Create your first internship posting</a>!</p>
                                    </div>
                                </td>
                            </tr>
                        `;
              return;
            }

            internships.forEach((internship) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                            <td><strong>${internship.title}</strong></td>
                            <td>${internship.location}</td>
                            <td><span class="badge badge-success">${internship.type}</span></td>
                            <td>${internship.skills}</td>
                            <td>AED ${internship.salary}</td>
                            <td>${internship.duration}</td>
                            <td>${internship.deadline}</td>
                            <td>
                                <div class="action-buttons">
                                    <button onclick="editInternship(${internship.internship_id})" class="btn btn-primary btn-sm">Edit</button>
                                    <button onclick="deleteInternship(${internship.internship_id})" class="btn btn-danger btn-sm">Delete</button>
                                </div>
                            </td>
                        `;
              tableBody.appendChild(row);
            });
          } else if (xhr.readyState === 4) {
            const tableBody = document.getElementById("internship-table-body");
            tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center">
                                <div class="error-state">
                                    <h3>Error loading internships</h3>
                                    <p>Please try again later or contact support if the problem persists.</p>
                                </div>
                            </td>
                        </tr>
                    `;
          }
        };
        xhr.send();
      }

      function clearSearch() {
        document.getElementById("internship-search-form").reset();
        loadInternships();
      }

      function editInternship(internshipId) {
        window.location.href = `/editinternship.html?internship_id=${internshipId}`;
      }

      function deleteInternship(internshipId) {
        if (
          !confirm(
            "Are you sure you want to delete this internship? This action cannot be undone and will remove all associated applications."
          )
        )
          return;

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/delete_internship", true);
        xhr.setRequestHeader(
          "Content-Type",
          "application/x-www-form-urlencoded"
        );
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4 && xhr.status === 200) {
            showNotification("Internship deleted successfully!", "success");
            loadInternships();
          } else if (xhr.readyState === 4) {
            showNotification("Error deleting internship", "error");
          }
        };
        xhr.send(`internship_id=${internshipId}`);
      }

      function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement("div");
        notification.className = `notification notification-${type}`;
        notification.textContent = message;

        // Style the notification
        notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                color: white;
                font-weight: 500;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                ${
                  type === "success"
                    ? "background: var(--success);"
                    : "background: var(--error);"
                }
            `;

        document.body.appendChild(notification);

        // Remove notification after 3 seconds
        setTimeout(() => {
          notification.style.animation = "slideOut 0.3s ease";
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      document
        .getElementById("internship-search-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const formData = new FormData(this);
          const searchParams = new URLSearchParams();
          for (const [key, value] of formData) {
            if (value) searchParams.append(key, value);
          }

          const xhr = new XMLHttpRequest();
          xhr.open("POST", "/search_internships", true);
          xhr.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
          );
          xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
              const internships = JSON.parse(xhr.responseText);
              const tableBody = document.getElementById(
                "internship-table-body"
              );
              tableBody.innerHTML = "";

              if (internships.length === 0) {
                tableBody.innerHTML = `
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="empty-state">
                                        <h3>No internships found</h3>
                                        <p>No internships match your search criteria.</p>
                                    </div>
                                </td>
                            </tr>
                        `;
                return;
              }

              internships.forEach((internship) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                            <td><strong>${internship.title}</strong></td>
                            <td>${internship.location}</td>
                            <td><span class="badge badge-success">${internship.type}</span></td>
                            <td>${internship.skills}</td>
                            <td>AED ${internship.salary}</td>
                            <td>${internship.duration}</td>
                            <td>${internship.deadline}</td>
                            <td>
                                <div class="action-buttons">
                                    <button onclick="editInternship(${internship.internship_id})" class="btn btn-primary btn-sm">Edit</button>
                                    <button onclick="deleteInternship(${internship.internship_id})" class="btn btn-danger btn-sm">Delete</button>
                                </div>
                            </td>
                        `;
                tableBody.appendChild(row);
              });
            } else if (xhr.readyState === 4) {
              const tableBody = document.getElementById(
                "internship-table-body"
              );
              tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center">
                                <div class="error-state">
                                    <h3>Error searching internships</h3>
                                    <p>Please try again later or contact support if the problem persists.</p>
                                </div>
                            </td>
                        </tr>
                    `;
            }
          };
          xhr.send(searchParams.toString());
        });

      window.onload = loadInternships;
    </script>
  </body>
</html>
