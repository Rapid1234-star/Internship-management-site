<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Internship Applications - Company Portal</title>
    <link rel="stylesheet" href="../css/styles.css" />
  </head>
  <body>
    <header>
      <div class="header-container">
        <nav class="nav">
          <div class="nav-container">
            <a href="/dashboardcompany.html" class="nav-brand"
              >Internship Portal</a
            >
            <ul class="nav-links">
              <li>
                <a href="/dashboardcompany.html" class="nav-link">Dashboard</a>
              </li>
              <li>
                <a href="/profilecompany.html" class="nav-link">Profile</a>
              </li>
              <li><a href="/logout" class="nav-link">Logout</a></li>
            </ul>
          </div>
        </nav>
      </div>
    </header>

    <main>
      <div class="section-heading">
        <h1>Internship Applications</h1>
        <p>
          Review and manage student applications for your internship
          opportunities
        </p>
      </div>

      <div class="search-container">
        <form id="application-search-form" class="search-form">
          <div class="search-filters">
            <div class="form-group">
              <label for="search" class="form-label"
                >Search by Student Name</label
              >
              <input
                type="text"
                id="search"
                name="search"
                class="form-input"
                placeholder="Enter student name"
              />
            </div>
          </div>
          <div class="search-actions">
            <button type="submit" class="btn btn-primary">
              Search Applications
            </button>
            <button type="button" class="btn btn-ghost" onclick="clearSearch()">
              Clear Search
            </button>
          </div>
        </form>
      </div>

      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Student Name</th>
              <th>Internship Title</th>
              <th>Email</th>
              <th>Status</th>
              <th>Applied Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="application-table-body">
            <tr>
              <td colspan="6" class="text-center">
                <div class="loading">
                  <div class="loading"></div>
                  <p>Loading applications...</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>

    <script>
      function loadApplications() {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", "/list_applications_company", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4 && xhr.status === 200) {
            const applications = JSON.parse(xhr.responseText);
            const tableBody = document.getElementById("application-table-body");
            tableBody.innerHTML = "";

            if (applications.length === 0) {
              tableBody.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="empty-state">
                                        <h3>No applications found</h3>
                                        <p>No student applications match your search criteria.</p>
                                    </div>
                                </td>
                            </tr>
                        `;
              return;
            }

            applications.forEach((app) => {
              const row = document.createElement("tr");
              const statusBadge = getStatusBadge(app.status);
              row.innerHTML = `
                            <td><strong>${app.student_name}</strong></td>
                            <td>${app.title}</td>
                            <td><a href="mailto:${
                              app.email
                            }" class="text-link">${app.email}</a></td>
                            <td>${statusBadge}</td>
                            <td>${app.applied_on || "N/A"}</td>
                            <td>
                                <div class="action-buttons">
                                    <button onclick="updateStatus(${
                                      app.application_id
                                    }, 'Accepted')" class="btn btn-success btn-sm">Accept</button>
                                    <button onclick="updateStatus(${
                                      app.application_id
                                    }, 'Rejected')" class="btn btn-danger btn-sm">Reject</button>
                                    <button onclick="deleteApplication(${
                                      app.application_id
                                    })" class="btn btn-ghost btn-sm">Delete</button>
                                </div>
                            </td>
                        `;
              tableBody.appendChild(row);
            });
          } else if (xhr.readyState === 4) {
            const tableBody = document.getElementById("application-table-body");
            tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center">
                                <div class="error-state">
                                    <h3>Error loading applications</h3>
                                    <p>Please try again later or contact support if the problem persists.</p>
                                </div>
                            </td>
                        </tr>
                    `;
          }
        };
        xhr.send();
      }

      function getStatusBadge(status) {
        const statusMap = {
          Pending: "badge badge-warning",
          Accepted: "badge badge-success",
          Rejected: "badge badge-error",
        };
        const badgeClass = statusMap[status] || "badge badge-warning";
        return `<span class="${badgeClass}">${status}</span>`;
      }

      function clearSearch() {
        document.getElementById("application-search-form").reset();
        loadApplications();
      }

      function updateStatus(applicationId, status) {
        if (
          !confirm(
            `Are you sure you want to ${status.toLowerCase()} this application?`
          )
        )
          return;

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/update_status", true);
        xhr.setRequestHeader(
          "Content-Type",
          "application/x-www-form-urlencoded"
        );
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4 && xhr.status === 200) {
            showNotification(
              `Application ${status.toLowerCase()} successfully!`,
              "success"
            );
            loadApplications();
          } else if (xhr.readyState === 4) {
            showNotification("Error updating application status", "error");
          }
        };
        xhr.send(`application_id=${applicationId}&status=${status}`);
      }

      function deleteApplication(applicationId) {
        if (
          !confirm(
            "Are you sure you want to delete this application? This action cannot be undone."
          )
        )
          return;

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/delete_application", true);
        xhr.setRequestHeader(
          "Content-Type",
          "application/x-www-form-urlencoded"
        );
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4 && xhr.status === 200) {
            showNotification("Application deleted successfully!", "success");
            loadApplications();
          } else if (xhr.readyState === 4) {
            showNotification("Error deleting application", "error");
          }
        };
        xhr.send(`application_id=${applicationId}`);
      }

      function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement("div");
        notification.className = `notification notification-${type}`;
        notification.textContent = message;

        // Style the notification
        notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                color: white;
                font-weight: 500;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                ${
                  type === "success"
                    ? "background: var(--success);"
                    : "background: var(--error);"
                }
            `;

        document.body.appendChild(notification);

        // Remove notification after 3 seconds
        setTimeout(() => {
          notification.style.animation = "slideOut 0.3s ease";
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      document
        .getElementById("application-search-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const formData = new FormData(this);
          const searchParams = new URLSearchParams();
          for (const [key, value] of formData) {
            if (value) searchParams.append(key, value);
          }

          const xhr = new XMLHttpRequest();
          xhr.open("POST", "/search_applications", true);
          xhr.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
          );
          xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
              const applications = JSON.parse(xhr.responseText);
              const tableBody = document.getElementById(
                "application-table-body"
              );
              tableBody.innerHTML = "";

              if (applications.length === 0) {
                tableBody.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="empty-state">
                                        <h3>No applications found</h3>
                                        <p>No student applications match your search criteria.</p>
                                    </div>
                                </td>
                            </tr>
                        `;
                return;
              }

              applications.forEach((app) => {
                const row = document.createElement("tr");
                const statusBadge = getStatusBadge(app.status);
                row.innerHTML = `
                            <td><strong>${app.student_name}</strong></td>
                            <td>${app.title}</td>
                            <td><a href="mailto:${
                              app.email
                            }" class="text-link">${app.email}</a></td>
                            <td>${statusBadge}</td>
                            <td>${app.applied_on || "N/A"}</td>
                            <td>
                                <div class="action-buttons">
                                    <button onclick="updateStatus(${
                                      app.application_id
                                    }, 'Accepted')" class="btn btn-success btn-sm">Accept</button>
                                    <button onclick="updateStatus(${
                                      app.application_id
                                    }, 'Rejected')" class="btn btn-danger btn-sm">Reject</button>
                                    <button onclick="deleteApplication(${
                                      app.application_id
                                    })" class="btn btn-ghost btn-sm">Delete</button>
                                </div>
                            </td>
                        `;
                tableBody.appendChild(row);
              });
            } else if (xhr.readyState === 4) {
              const tableBody = document.getElementById(
                "application-table-body"
              );
              tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center">
                                <div class="error-state">
                                    <h3>Error searching applications</h3>
                                    <p>Please try again later or contact support if the problem persists.</p>
                                </div>
                            </td>
                        </tr>
                    `;
            }
          };
          xhr.send(searchParams.toString());
        });

      window.onload = loadApplications;
    </script>
  </body>
</html>
